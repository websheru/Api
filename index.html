<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sheru Nexus God Mode</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --surface: #0f0f11;
            --surface-light: #18181b;
            --primary: #6366f1; /* Indigo */
            --accent: #06b6d4;  /* Cyan */
            --gold: #fbbf24;    /* Amber */
            --text: #ffffff;
            --text-muted: #9ca3af;
            --border: rgba(255,255,255,0.08);
            --nav-bg: rgba(15, 15, 17, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Urbanist', sans-serif;
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* --- UTILS --- */
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .col { flex-direction: column; }
        .w-full { width: 100%; }
        .font-bold { font-weight: 700; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.9rem; }
        .text-gold { color: var(--gold); }
        .text-accent { color: var(--accent); }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }

        /* --- HEADER --- */
        .header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(20px);
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: 0.5px; }
        .coin-box {
            background: var(--surface-light); padding: 6px 12px; border-radius: 30px;
            border: 1px solid var(--border); font-size: 0.9rem; font-weight: 700;
            display: flex; gap: 6px; align-items: center;
        }

        /* --- ITEM CARD --- */
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 18px; margin-bottom: 12px; overflow: hidden;
            transition: border-color 0.2s;
        }
        .card:active { transform: scale(0.99); }
        
        .card-header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .card-icon {
            width: 48px; height: 48px; border-radius: 12px; background: var(--surface-light);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text);
        }
        
        /* Badges */
        .badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; margin-left: 6px; }
        .bg-api { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
        .bg-script { background: rgba(6, 182, 212, 0.2); color: #67e8f9; }
        .bg-bot { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }

        /* Dropdown & Arrow */
        .dropdown-content {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out;
            background: #0a0a0c; border-top: 1px solid var(--border);
        }
        .content-inner { padding: 15px; }
        
        .arrow-box {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s; color: var(--text-muted);
        }
        .rotate-arrow { transform: rotate(180deg); color: var(--primary); }

        /* Button */
        .btn-buy {
            background: var(--text); color: #000; border: none; padding: 8px 16px; 
            border-radius: 10px; font-weight: 800; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;
        }
        .btn-buy:active { transform: scale(0.95); background: var(--primary); color: white; }

        /* --- PREVIEW BOX --- */
        .preview-box {
            background: #000; border: 1px dashed var(--border); border-radius: 10px; padding: 12px;
            font-family: monospace; font-size: 0.75rem; color: var(--accent); margin-bottom: 15px;
            position: relative;
        }
        .copy-icon { position: absolute; top: 8px; right: 8px; color: var(--text-muted); cursor: pointer; }

        /* --- TABS --- */
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px; scrollbar-width: none; }
        .chip {
            padding: 8px 18px; border-radius: 20px; background: var(--surface); border: 1px solid var(--border);
            color: var(--text-muted); font-size: 0.85rem; font-weight: 600; white-space: nowrap; transition: 0.2s;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- HISTORY LIST --- */
        .history-row {
            display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border);
        }
        .history-row:last-child { border-bottom: none; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: var(--surface); border: 1px solid var(--border); width: 85%; padding: 25px;
            border-radius: 20px; text-align: center; transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        /* --- NAV --- */
        .nav-dock {
            position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 100;
            background: var(--nav-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 24px;
            display: flex; justify-content: space-around; padding: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .nav-item { color: #666; font-size: 1.5rem; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--primary); transform: translateY(-4px); }
        .dot { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; opacity: 0; margin-top: 4px; }
        .nav-item.active .dot { opacity: 1; }

    </style>
</head>
<body>

    <div class="header flex justify-between">
        <div class="logo">Sheru<span style="color:var(--primary)">Nexus</span></div>
        <div class="coin-box">
            <span class="text-gold">ü¶Å</span> <span id="userBal">...</span>
        </div>
    </div>

    <div id="home" class="page active" style="padding: 20px;">
        <div style="background: linear-gradient(135deg, #1e1b4b, #000); border: 1px solid var(--primary); border-radius: 20px; padding: 25px; position:relative; overflow:hidden; margin-bottom: 25px;">
            <h2 style="font-size:1.5rem; font-weight:800; line-height:1.2;">Monetize Your <br><span style="color:#a5b4fc">Code & APIs</span></h2>
            <p style="font-size:0.85rem; color:#818cf8; margin-top:8px; width:70%;">Join our developer marketplace and earn passive income.</p>
            <button onclick="tg.openTelegramLink('https://t.me/SheruSellBot')" style="margin-top:15px; background:white; color:black; border:none; padding:8px 18px; border-radius:8px; font-weight:800; font-size:0.85rem;">Start Selling</button>
            <i class="ri-code-box-line" style="position:absolute; right:-10px; bottom:-10px; font-size:6rem; opacity:0.1; color:white;"></i>
        </div>

        <h3 style="font-weight:800; font-size:1.1rem; display:flex; gap:5px; margin-bottom:10px;">
            <i class="ri-fire-fill text-gold"></i> Hot Picks
        </h3>
        <div id="hotList"></div>
    </div>

    <div id="store" class="page" style="padding-top: 10px;">
        <div class="tabs">
            <div class="chip active" onclick="filter('all', this)">All</div>
            <div class="chip" onclick="filter('script', this)">Scripts</div>
            <div class="chip" onclick="filter('bot', this)">Bots</div>
            <div class="chip" onclick="filter('api', this)">APIs</div>
        </div>

        <div id="itemList" style="padding: 10px 20px 100px;"></div>
    </div>

    <div id="refer" class="page" style="padding: 20px;">
        <div style="text-align:center; padding: 30px; background:var(--surface); border-radius:20px; border:1px solid var(--border);">
            <i class="ri-trophy-fill" style="font-size:3rem; color:var(--gold);"></i>
            <h2 style="font-size:1.8rem; font-weight:900; margin:10px 0;">INVITE FRIENDS</h2>
            <p style="color:var(--text-muted); font-size:0.9rem;">
                Earn <b class="text-gold">1 ü¶Å</b> per invite<br>+ <b class="text-accent">25% Commission</b> on deposits.
            </p>
            
            <div style="margin-top:20px; background:#000; padding:12px; border-radius:12px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <span id="refLink" style="color:#666; font-size:0.8rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">Loading...</span>
                <button onclick="shareReferral()" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:8px;"><i class="ri-share-forward-line"></i></button>
            </div>
        </div>

        <h3 style="margin: 25px 0 10px; font-weight:800;">Referral History</h3>
        <div id="referHistory" style="padding-bottom:100px;">
            <div class="text-center text-muted text-sm mt-5">No referrals yet.</div>
        </div>
    </div>

    <div id="profile" class="page" style="padding: 20px;">
        <div style="background:var(--surface); padding:20px; border-radius:20px; border:1px solid var(--border); margin-bottom:20px;">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold" id="profileName">User</h2>
                    <div class="text-xs text-muted">ID: <span id="userId">...</span></div>
                </div>
                <div style="text-align:right;">
                    <div class="text-xs text-muted font-bold">BALANCE</div>
                    <div class="text-2xl font-black text-gold">ü¶Å <span id="profileBal">0</span></div>
                </div>
            </div>
            
            <div class="flex gap-2 mt-5">
                <button onclick="showAlert('deposit')" class="w-full" style="background:#fff; color:#000; border:none; padding:10px; border-radius:10px; font-weight:800;">Deposit</button>
                <button onclick="showAlert('payout')" class="w-full" style="background:#222; color:#fff; border:1px solid #333; padding:10px; border-radius:10px; font-weight:800;">Payout</button>
            </div>
        </div>

        <h3 style="margin-bottom:10px; font-weight:800; font-size:1.1rem;">My Collection</h3>
        <div id="myHistory" style="padding-bottom:100px;"></div>
    </div>

    <div class="modal-overlay" id="alertModal">
        <div class="modal-box">
            <div id="modalIcon" style="font-size: 3rem; margin-bottom: 10px;"></div>
            <h3 id="modalTitle" style="font-size: 1.4rem; font-weight: 800; margin-bottom: 10px;">Alert</h3>
            <p id="modalMsg" style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 25px; line-height: 1.5;"></p>
            <button onclick="closeModal()" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:12px; font-weight:bold;">Got it</button>
        </div>
    </div>

    <div class="nav-dock">
        <div class="nav-item active" onclick="nav('home', this)"><i class="ri-home-5-line"></i><div class="dot"></div></div>
        <div class="nav-item" onclick="nav('store', this)"><i class="ri-layout-grid-line"></i><div class="dot"></div></div>
        <div class="nav-item" onclick="nav('refer', this)"><i class="ri-group-line"></i><div class="dot"></div></div>
        <div class="nav-item" onclick="nav('profile', this)"><i class="ri-user-3-line"></i><div class="dot"></div></div>
    </div>

    <script>
        // --- ‚öôÔ∏è CONFIGURATION ---
        const BACKEND_URL = "https://sheru-api.amritw1.workers.dev"; // Needs to be active for Auth
        const BOT_USERNAME = "SheruApiBot"; // Your Bot Username (No @)

        // --- üìÇ LOCAL DATA (JSON) ---
        // Server upload ki zarurat nahi, items yahan define karo.
        const DATA = [
            { 
                id: 101, type: 'API', name: 'Instagram Downloader', price: 50, 
                desc: 'Download Reels, Stories & Posts without login.',
                icon: 'ri-instagram-line', 
                demo_url: 'https://api.sheru.com/insta?url=...',
                response: '{"status":"success", "url":"http://video.mp4"}'
            },
            { 
                id: 102, type: 'SCRIPT', name: 'Python DDoS Script', price: 150, 
                desc: 'Powerful L7 Attack script written in Python 3.',
                icon: 'ri-skull-line', 
                demo_url: 'Source Code File (25KB)',
                response: '# This is a preview of the code...'
            },
            { 
                id: 103, type: 'BOT', name: 'Auto Filter Bot', price: 200, 
                desc: 'Telegram movie filter bot source code with database.',
                icon: 'ri-robot-2-line', 
                demo_url: 'Bot Source Code (Zip)',
                response: 'Structure: /plugins, /database, main.py'
            },
            { 
                id: 104, type: 'API', name: 'ChatGPT-4 Free', price: 80, 
                desc: 'Access GPT-4 models without OpenAI key.',
                icon: 'ri-openai-line', 
                demo_url: 'https://api.sheru.com/gpt?q=Hi',
                response: '{"reply": "Hello! How can I help you?"}'
            }
        ];

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let state = { user: null, owned: [] };

        // --- üöÄ INIT ---
        async function init() {
            try {
                // 1. Auth with Backend (Only for Balance/User Info)
                let authRes = await fetch(`${BACKEND_URL}/api/auth`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData })
                });
                let auth = await authRes.json();
                state.user = auth.user;

                // 2. Mock Owned Items (In real app, fetch from DB)
                // For now, let's say user owns item 101 if balance > 500
                if(state.user.balance > 500) state.owned.push(101);

                // 3. Deep Link Handler (Popup logic)
                const startParam = tg.initDataUnsafe.start_param;
                if(startParam && startParam.startsWith('item_')) {
                    const itemId = parseInt(startParam.split('_')[1]);
                    // Auto switch to store and open item
                    setTimeout(() => {
                        nav('store', document.querySelectorAll('.nav-item')[1]);
                        toggleDetails(`store-${itemId}`);
                    }, 500);
                }

                renderUI();
            } catch (e) {
                console.error(e);
                // Offline Fallback
                state.user = { first_name: "Guest", balance: 0, tg_id: 0, total_refs: 0 };
                renderUI();
            }
        }

        // --- üé® RENDER ---
        function renderUI() {
            // Header Stats
            document.querySelectorAll('#userBal, #profileBal').forEach(e => e.innerText = state.user.balance);
            document.getElementById('profileName').innerText = state.user.first_name;
            document.getElementById('userId').innerText = state.user.tg_id;
            
            // Refer Link
            document.getElementById('refLink').innerText = `https://t.me/${BOT_USERNAME}?start=${state.user.tg_id}`;

            // Render Lists (Unique IDs to fix dropdown bug)
            renderList(DATA, 'itemList', 'store');
            renderList(DATA.slice(0, 2), 'hotList', 'home');
            
            renderHistory();
        }

        function renderList(list, containerId, context) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";

            list.forEach(item => {
                const isOwned = state.owned.includes(item.id);
                const uniqueId = `${context}-${item.id}`; // FIX: Unique ID for every card

                let badgeColor = item.type === 'API' ? 'bg-api' : (item.type === 'SCRIPT' ? 'bg-script' : 'bg-bot');
                
                const html = `
                <div class="card">
                    <div class="card-header" onclick="toggleDetails('${uniqueId}')">
                        <div class="flex gap-3">
                            <div class="card-icon"><i class="${item.icon}"></i></div>
                            <div>
                                <div class="flex gap-2">
                                    <div class="font-bold" style="font-size:0.95rem;">${item.name}</div>
                                    <span class="badge ${badgeColor}">${item.type}</span>
                                </div>
                                <div class="text-muted text-xs" style="margin-top:2px;">
                                    Click for details
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button class="btn-buy" onclick="event.stopPropagation(); buy('${item.type}', ${item.id})">
                                ${isOwned ? '<i class="ri-check-double-line text-accent"></i> Owned' : `<span class="text-gold">ü¶Å</span> ${item.price}`}
                            </button>
                            <div class="arrow-box" id="arrow-${uniqueId}">
                                <i class="ri-arrow-down-s-line" style="font-size:1.2rem;"></i>
                            </div>
                        </div>
                    </div>

                    <div id="details-${uniqueId}" class="dropdown-content">
                        <div class="content-inner">
                            <div class="flex justify-between mb-3" style="background:#151515; padding:10px; border-radius:8px;">
                                <div class="text-center">
                                    <div class="text-xs text-muted font-bold">TYPE</div>
                                    <div class="font-bold text-sm text-accent">${item.type}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-muted font-bold">VALIDITY</div>
                                    <div class="font-bold text-sm">Lifetime</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-muted font-bold">SUPPORT</div>
                                    <div class="font-bold text-sm text-gold">24/7</div>
                                </div>
                            </div>

                            <p class="text-muted text-sm mb-3">${item.desc}</p>

                            <div class="text-xs text-muted font-bold mb-1">DEMO / ENDPOINT</div>
                            <div class="preview-box" onclick="copy('${item.demo_url}')">
                                ${item.demo_url}
                                <i class="ri-file-copy-line copy-icon"></i>
                            </div>

                            <div class="text-xs text-muted font-bold mb-1">RESPONSE PREVIEW</div>
                            <div class="preview-box" style="color:#10b981;">
                                ${item.response}
                            </div>

                            <div style="display:flex; justify-content:flex-end;">
                                <button onclick="shareItem(${item.id})" style="background:transparent; color:var(--text-muted); border:none; display:flex; gap:5px; align-items:center;">
                                    <i class="ri-share-forward-line"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function renderHistory() {
            // Fake History for UI
            const container = document.getElementById('myHistory');
            if(state.owned.length === 0) {
                container.innerHTML = `<div class="text-center text-muted text-sm mt-5">You haven't bought anything yet.</div>`;
                return;
            }
            // Logic to show owned items would go here
        }

        // --- ‚ö° ACTIONS ---
        
        function toggleDetails(uniqueId) {
            // FIX: Works perfectly now because IDs are unique
            const el = document.getElementById(`details-${uniqueId}`);
            const arrow = document.getElementById(`arrow-${uniqueId}`);
            
            if (el.style.maxHeight) {
                el.style.maxHeight = null;
                arrow.classList.remove('rotate-arrow');
            } else {
                // Close others first (Optional UI polish)
                document.querySelectorAll('.dropdown-content').forEach(d => d.style.maxHeight = null);
                document.querySelectorAll('.arrow-box').forEach(a => a.classList.remove('rotate-arrow'));
                
                el.style.maxHeight = el.scrollHeight + "px";
                arrow.classList.add('rotate-arrow');
            }
        }

        function buy(type, id) {
            // Logic: Close WebApp -> Send User to Bot -> Trigger Start Param
            tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=${type.toLowerCase()}_${id}`);
            tg.close(); // IMPORTANT: Minimize app so user sees the bot
        }

        function filter(type, btn) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            
            const filtered = type === 'all' ? DATA : DATA.filter(i => i.type.toLowerCase() === type);
            renderList(filtered, 'itemList', 'store');
        }

        function nav(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- üîó SHARING & ALERTS ---

        function shareItem(id) {
            // Generates link: t.me/Bot/app?startapp=item_101
            const link = `https://t.me/${BOT_USERNAME}/app?startapp=item_${id}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=Check out this cool item on Sheru Nexus!`);
        }

        function shareReferral() {
            const link = document.getElementById('refLink').innerText;
            tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=Join and earn rewards!`);
        }

        function showAlert(type) {
            const modal = document.getElementById('alertModal');
            const icon = document.getElementById('modalIcon');
            const title = document.getElementById('modalTitle');
            const msg = document.getElementById('modalMsg');

            modal.classList.add('open');

            if(type === 'deposit') {
                icon.innerHTML = 'üíé'; title.innerText = "Add Funds";
                msg.innerHTML = "To add funds, please close this app and use the <b class='text-accent'>/deposit</b> command in the bot chat.";
            } else if(type === 'payout') {
                icon.innerHTML = 'üè¶'; title.innerText = "Withdraw";
                msg.innerHTML = "To withdraw earnings, use the <b class='text-gold'>/payout</b> command in the bot chat.";
            }
        }

        function closeModal() { document.getElementById('alertModal').classList.remove('open'); }
        function copy(txt) { navigator.clipboard.writeText(txt); tg.showAlert("Copied!"); }

        window.onload = init;

    </script>
</body>
</html>
